{% extends "base.html" %}
{% block title %}Home - MedFlowAI{% endblock %}

{% block content %}
<div x-data="{
    score: {{ score }},
    status: 'Calculating...',
    color: '#8B5CF6',
    showFeedback: false,
    feedback: '',
    loading: false,
    briefSummaries: {
        'consum': '{{ consum_txt }}',
        'somn': '{{ somn_txt }}',
        'vitale': '{{ vitale_txt }}',
        'sport': '{{ sport_txt }}'
    },

    getColorForScore(score) {
        if (score >= 80) return '#10B981';
        if (score >= 50) return '#8B5CF6';
        if (score > 0) return '#EF4444';
        return '#9CA3AF'; // Gri pt 0
    },

    getStatusForScore(score) {
        if (score == 0) return 'Start logging data!';
        if (score >= 80) return 'Crushing it!';
        if (score >= 50) return 'Keep going!';
        return 'Need some care';
    },

    async generateFeedback() {
        if (this.feedback) { this.showFeedback = true; return; }
        this.loading = true;
        try {
            const res = await fetch('/api/v1/generate_alert');
            const data = await res.json();
            this.feedback = data.feedback;
            this.showFeedback = true;
        } catch(e) { console.error(e); }
        this.loading = false;
    },

    init() {
        this.color = this.getColorForScore(this.score);
        this.status = this.getStatusForScore(this.score);
    }
}" class="space-y-6">

    <div class="text-center">
        <img src="/assets/logopreview1.png" alt="Logo" class="w-75 mx-auto mb-4" onerror="this.style.display='none'">
        <div class="flex flex-col items-center justify-center space-y-2">
            <p class="text-gray-600 text-sm">Welcome back,</p>
            <h2 class="text-xl font-bold text-gray-900 leading-none">{{ name }}</h2>

            <a href="/logout"
               class="mt-2 inline-flex items-center space-x-1 px-4 py-1.5 border border-red-200 bg-red-50 text-red-500 rounded-full text-xs font-bold hover:bg-red-500 hover:text-white hover:border-red-500 transition-all duration-300 group">
                <span>Log Out</span>
                <svg class="w-3 h-3 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                </svg>
            </a>
        </div>
    </div>

    <div class="bg-white rounded-2xl shadow-lg p-6">
        <div>
            <h2 class="text-gray-600 text-sm font-medium mb-2">Logging Progress</h2>
            <h3 class="text-2xl font-bold text-gray-900 mb-4" x-text="status"></h3>

            <div class="relative w-full h-8 bg-gray-200 rounded-full overflow-hidden">
                <div class="h-full rounded-full transition-all duration-1000 ease-out flex items-center justify-end pr-2"
                     :style="`width: ${score}%; background-color: ${color}`">
                     <span x-show="score > 15" class="text-white text-sm font-bold drop-shadow-md" x-text="score + '%'"></span>
                </div>

                <div x-show="score <= 15" class="absolute inset-0 flex items-center justify-center">
                    <span class="text-gray-600 text-sm font-bold" x-text="score + '%'"></span>
                </div>
            </div>

            <p class="text-gray-500 text-sm mt-3 text-center">Your health score today</p>
        </div>
    </div>

    <div class="bg-white rounded-2xl shadow-lg p-6">
        <h3 class="text-lg font-bold text-gray-900 mb-4">You've logged today</h3>
        <div class="space-y-3">
            <div class="flex items-center justify-between p-3 bg-orange-50 rounded-lg">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl">üçΩÔ∏è</span>
                    <div>
                        <p class="text-sm font-semibold text-gray-700">Nutrition</p>
                        <p class="text-xs text-gray-500" x-text="briefSummaries.consum"></p>
                    </div>
                </div>
            </div>
            <div class="flex items-center justify-between p-3 bg-purple-50 rounded-lg">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl">üò¥</span>
                    <div>
                        <p class="text-sm font-semibold text-gray-700">Sleep</p>
                        <p class="text-xs text-gray-500" x-text="briefSummaries.somn"></p>
                    </div>
                </div>
            </div>
            <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl">‚ù§Ô∏è</span>
                    <div>
                        <p class="text-sm font-semibold text-gray-700">Vitals</p>
                        <p class="text-xs text-gray-500" x-text="briefSummaries.vitale"></p>
                    </div>
                </div>
            </div>
            <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                <div class="flex items-center space-x-3">
                    <span class="text-2xl">üèÉ</span>
                    <div>
                        <p class="text-sm font-semibold text-gray-700">Activity</p>
                        <p class="text-xs text-gray-500" x-text="briefSummaries.sport"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl shadow-lg p-6 text-white">
        <button @click="generateFeedback()" :disabled="loading"
                class="w-full bg-white text-blue-600 font-bold py-3 px-6 rounded-lg hover:bg-blue-50 transition flex justify-center items-center">
            <span x-show="!loading && !showFeedback">Get Your Status</span>
            <span x-show="loading">Analyzing...</span>
            <span x-show="!loading && showFeedback">‚úì View Feedback</span>
        </button>
    </div>

    <template x-if="showFeedback && feedback">
        <div class="bg-white rounded-2xl shadow-lg p-6 mt-4">
            <h4 class="text-lg font-bold text-gray-900 mb-3 border-b pb-2">Analysis Report</h4>
            <div class="text-sm text-gray-700 space-y-2">
                <template x-for="(line, index) in feedback.split('\n')" :key="index">
                    <p x-html="line.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')" class="min-h-[10px]"></p>
                </template>
            </div>
        </div>
    </template>

    <div class="grid grid-cols-2 gap-4">
        <a href="/chat" class="bg-white rounded-xl shadow p-4 text-center hover:shadow-lg transition">
            <div class="text-3xl mb-2">üí¨</div>
            <p class="text-sm font-semibold text-gray-700">Chat with AI</p>
        </a>
        <a href="/add-data" class="bg-white rounded-xl shadow p-4 text-center hover:shadow-lg transition">
            <div class="text-3xl mb-2">‚ûï</div>
            <p class="text-sm font-semibold text-gray-700">Add Data</p>
        </a>
    </div>
</div>
{% endblock %}